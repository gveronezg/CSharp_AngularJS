<!DOCTYPE html>
<html ng-app="app">
<head>
    <meta charset="UTF-8">
    <title>Usuários App</title>

    <!-- ✅ Carrega primeiro a biblioteca Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

    <!-- ✅ Depois a biblioteca AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
</head>

<body ng-controller="UsuariosController">

    <p>Status: {{status}}</p>
    <p ng-if="token">Token: {{token}}</p>

    <h2>Login</h2>
    <form ng-submit="login()">
        <input type="email" ng-model="loginData.email" placeholder="Email" required>
        <input type="password" ng-model="loginData.password" placeholder="Senha" required>
        <button type="submit">Entrar</button>
    </form>

    <button ng-click="logout()" ng-if="status === 'Logado'">Sair</button>

    <h1>Cadastrar Novo Usuário</h1>
    <form ng-submit="adicionarUsuario()">
        <input type="text" ng-model="novoUsuario.nome" placeholder="Nome" required>
        <input type="email" ng-model="novoUsuario.email" placeholder="Email" required>
        <button type="submit">Cadastrar</button>
    </form>

    <h2>Usuários já Cadastrados:</h2>
    <ul>
        <li ng-repeat="u in usuarios">
            {{u.id}} - {{u.nome}} ({{u.email}})
            <button ng-click="editarUsuario(u)">Editar</button>
            <button ng-click="excluirUsuario(u)">Excluir</button>
        </li>
    </ul>

    <h2>Editando Usuário</h2>
    <form ng-submit="atualizarUsuario()">
        <input type="hidden" ng-model="usuarioEditando.id">
        <input type="text" ng-model="usuarioEditando.nome" placeholder="Nome" required>
        <input type="email" ng-model="usuarioEditando.email" placeholder="Email" required>
        <button type="submit">Atualizar</button>
        <button type="button" ng-click="cancelarEdicao()">Cancelar</button>
    </form>

    <script>
        // ✅ 1. Primeiro criamos a instância do cliente Supabase
        const supabaseUrl = 'https://jhqlfzrqcbhjguzabfna.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6Ikp...'; // ⚠️ mantenha seguro!
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // ✅ 2. Agora criamos o módulo AngularJS
        angular.module('app', [])
            .controller('UsuariosController', function($scope, $http) {

                // ✅ Variáveis de controle de estado
                $scope.status = 'Deslogado';
                $scope.token = null;

                $scope.loginData = {};
                $scope.usuarios = [];
                $scope.novoUsuario = {};
                $scope.usuarioEditando = {};

                const apiUrl = 'http://localhost:5292/usuarios';

                // ✅ Configura o cabeçalho Authorization
                function getAuthConfig() {
                    return {
                        headers: {
                            'Authorization': 'Bearer ' + $scope.token
                        }
                    };
                }

                // ✅ Autenticação
                $scope.login = async function() {
                    console.log('Tentando login com:', $scope.loginData);

                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: $scope.loginData.email,
                        password: $scope.loginData.password
                    });

                    console.log('Resultado login:', data, error);

                    if (error) {
                        alert('Erro ao logar: ' + error.message);
                    } else {
                        $scope.token = data.session.access_token;
                        $scope.status = 'Logado';
                        $scope.$apply();
                        carregarUsuarios();
                    }
                };

                $scope.logout = async function() {
                    await supabase.auth.signOut();
                    $scope.token = null;
                    $scope.status = 'Deslogado';
                    $scope.usuarios = [];
                    $scope.$apply();
                };

                async function verificarSessao() {
                    const { data: { session }, error } = await supabase.auth.getSession();
                    console.log('Verificando sessão:', session, error);

                    if (session) {
                        $scope.token = session.access_token;
                        $scope.status = 'Logado';
                        carregarUsuarios();
                    } else {
                        $scope.status = 'Deslogado';
                    }
                    $scope.$apply();
                }

                function carregarUsuarios() {
                    if ($scope.token) {
                        console.log('Carregando usuários com token:', $scope.token);

                        $http.get(apiUrl, getAuthConfig()).then(function(response) {
                            console.log('Usuários carregados:', response.data);
                            $scope.usuarios = response.data;
                        }, function(err) {
                            console.error('Erro ao carregar usuários:', err);
                        });
                    }
                }

                $scope.adicionarUsuario = function() {
                    $http.post(apiUrl, $scope.novoUsuario, getAuthConfig()).then(function() {
                        $scope.novoUsuario = {};
                        carregarUsuarios();
                    });
                };

                $scope.editarUsuario = function(usuario) {
                    $scope.usuarioEditando = angular.copy(usuario);
                };

                $scope.cancelarEdicao = function() {
                    $scope.usuarioEditando = {};
                };

                $scope.atualizarUsuario = function() {
                    $http.put(apiUrl + '/' + $scope.usuarioEditando.id, $scope.usuarioEditando, getAuthConfig()).then(function() {
                        carregarUsuarios();
                        $scope.cancelarEdicao();
                    });
                };

                $scope.excluirUsuario = function(usuario) {
                    if (confirm('Tem certeza que deseja excluir este usuário?')) {
                        $http.delete(apiUrl + '/' + usuario.id, getAuthConfig()).then(function() {
                            carregarUsuarios();
                        });
                    }
                };

                verificarSessao();
            });
    </script>
</body>
</html>
